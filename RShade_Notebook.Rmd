---
title: "R Notebook"
output: html_notebook
---

Start by setting the parameters for running RShade.

```{r}
# Input lines can come from either a shapefile or file geodatabase.

input_lines <- "data/Flowlines.gdb"

input_lines_feature_name <- "NHDFlowline"

# Sample angles can only contain the angles 0, 45, 135, 180, 225, 270, 315. 
# Values can be removed, but new values cannot be added

star_sample_angles <- c(0, 45, 90, 135, 180, 225, 270, 315)

# Distances are in meters

star_sample_distances <- c(3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36, 39)

# If you wish to use the provided grids for horizon angle, vegetation cover, and 
# vegetation height, set the vales below to FALSE. Otherwise, populate with the
# file path "data/yourGrid.tif".

personal_horizon_angle <- FALSE

personal_veg_cover <- FALSE

personal_veg_height <- FALSE
```

Next, run the initialization processes. If this is your first time running RShade,
this step may take a few minutes as it installs the required libraries and
downloads the required files.

```{r}
source("initialize.R")
source("RShade.R")
```

This step imports your NHDPlus HR lines, retrieves the correct columns, and 
gets is into the correct coordinate system.

```{r}
nhdr_lines <- read_nhdplus_lines(input_lines, input_lines_feature_name)
```

This step generates sample points at 50 meter intervals along your input dataset.
Keep in mind the output changes each time this is run. This may take a few minutes,
especially if your input dataset is large.

```{r}
shade_points <- sample_shade_points(nhdr_lines)
```

This step calculates the bankfull width (BFW) of each shade point. By default, this 
function will start by using a mathematical equation to calculate BFW and then
move on to checking for available river/stream boundary polygons and measuring
the BFW of applicable shade points using the length of perpendicular
transects of these polygons. If you wish to only use the equation, set
"use.transect" to FALSE.

This step downloads one or more geodatabases, and may take a few minutes.

```{r}
RShade_points <- calc_BFW(shade_points, nhdr_lines, use.transect = TRUE)
```


This step adds and populates latitude and longitude fields.

```{r}
RShade_points <- add_latlon(RShade_points)
```

This step retrieves the values of an input raster stack at each point and puts
those values in the correct fields. This step involves downloading what could
be a fairly large raster dataset, which could take a few minutes. Each raster only
needs to be downloaded the first time it is used. Future versions of this tool 
will utilize smaller files to reduce download times. 

If you are using a your own horizon angle dataset, it must be in the following format:
Band 1: Elevation (m)
Band 2: 0-degrees Horizon Angle
Band 2: 45-degrees Horizon Angle
Band 2: 90-degrees Horizon Angle
Band 2: 135-degrees Horizon Angle
Band 2: 180-degrees Horizon Angle
Band 2: 225-degrees Horizon Angle
Band 2: 270-degrees Horizon Angle
Band 2: 315-degrees Horizon Angle

```{r}
RShade_points <- extract_horizon_angle(RShade_points, rpu_boundaries)
```

The next two steps extract vegetation cover and height values from the resampled
Landfire grids. The more angles and distances sampled, the longer these steps 
will take. 

```{r}
RShade_points <- star_sample(RShade_points, veg_cover, star_sample_angles, star_sample_distances, type="hght")
```

```{r}
RShade_points <- star_sample(RShade_points, veg_cover, star_sample_angles, star_sample_distances, type="cvr")
```

The final optional steps allow you to export the final result as either a .csv or 
shapefile. These can then be downloaded from the "Files" window.

```{r}
st_write(RShade_points, "data/Output.shp")
```

```{r}
write_csv(RShade_points, "data/Output.csv")
```

